<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head><meta content="text/html; charset=ISO-8859-1" http-equiv="content-type"><title>Serial_Link_Info</title></head>
<body><h3>Serial (RS232) Communications:</h3><span style="font-family: monospace;"><span style="text-decoration: underline;">Utilities: See the folder ("PC-based-apps")</span><br><br>Two Windows based tools for PC-V6Z80P communications are supplied:<br><br><span style="font-weight: bold;">Serial_link.exe</span> - this is a GUI style PC app which allows files to sent and received.<br><span style="font-weight: bold;">SerialTX.exe</span> - this is a console style PC app that allows files to sent from the Windows command line to the V6Z80P.<br><br>(There is also a Linux version of SerialTX called sendv6 - see the folder Contributions/Daniel.)<br><br>The&nbsp;V6Z80P's default baud rate is 115200, format 8-N-1 (57600 baud can also be selected).<br><br></span><hr style="width: 100%; height: 2px;"><h3><span style="font-family: monospace;"></span><span style="font-family: monospace;"></span>Serial_Link.exe details:</h3><span style="font-family: monospace;">To send a file to the V6Z80P's memory from the PC, in FLOS enter:<br><br>RX <span style="font-style: italic;">filename address [bank]</span><br><br>&nbsp;Notes:<br><br>&nbsp;&nbsp;&nbsp; &nbsp;If&nbsp;filename is "*" - whatever file sent is accepted.<br>&nbsp;&nbsp;&nbsp;&nbsp; If filename is "!" - the file is executed upon reception.<br>&nbsp;<br>&nbsp;&nbsp;&nbsp; &nbsp;"address" should be in the range $5000-$FFFF<br><br>&nbsp;&nbsp;&nbsp; &nbsp;[bank] is the upper bank number where it should load (only<br>&nbsp;&nbsp;&nbsp; &nbsp;relevant if address &gt; $7FFF). If not specified, the current bank<br>&nbsp;&nbsp;&nbsp; &nbsp;is used.<br><br>FLOS will say "Waiting for file...". On the PC Serial Link util, click<br>"send file", and choose a file to send.<br><br>To send a file from the PC direct to the V6Z80P's SD card (current directory)<br>use the command: FRX [path]<br></span><span style="font-family: monospace;"><br><br>To send a file from the V6Z80P's memory to the PC,&nbsp;click "Receive File" on<br>the PC serial link util, then in FLOS enter:<br><br>TX <span style="font-style: italic;">filename address length [bank]</span><br><br>The Serial Link PC util&nbsp;will time out after a few seconds if no files are<br>forthcoming.<br><br></span><span style="font-family: monospace;">To send a file from the&nbsp;V6Z80P's SD card (current directory) to the PC<br>use the command: FILETX <span style="font-style: italic;">fileame</span></span><br>&nbsp;<br><h3>SerialTX.exe Details:<span style="font-family: monospace;"></span></h3><span style="font-family: monospace;">To send a file from the PC command line to the V6Z80P&nbsp;use SerialTX.exe as follows:<br><br>SerialTX filename <span style="font-style: italic;">[COMn] [Baud]</span><br><br><span style="font-style: italic;">COMn</span> is the serial port you're using on the PC (EG: COM1, COM2 etc) If this is not supplied<br>SerialTX will scan the PC and use the first serial port it finds. <br><br>If <span style="font-style: italic;">Baud</span> is not supplied, the default 115200 baud is used. The only other option is 57600<br>(if this is used, then the COM port must be specified also).<br><br>(Obviously you need to use RX, FRX or have a serial requester waiting at the V6Z80 end.)<br><br>SerialTX.exe can be set up as a helper tool in&nbsp;various text editors allowing files<br>to be assembled and passed&nbsp;to the V6Z80P with little interaction. It can also be<br>handy to add it to the Windows "Send to" list allowing files to sent using the<br>right click context menu.<br><br></span><hr style="width: 100%; height: 2px;"><span style="font-family: monospace;"><br><br><span style="text-decoration: underline;">Serial link data protocol - used by RX/TX commands and PC-side utils</span><br><br><br>To send a file:<br>---------------<br><br>&nbsp;1. Create and send a file header packet (see format below)<br>&nbsp;2. Wait for ASCII bytes "OK" from receiver - anything else signifies an error.<br>&nbsp;3. Send file byte packet of 256 bytes.<br>&nbsp;4. Send 2 byte CRC checksum of packet<br>&nbsp;5. Wait for "OK" from receiver - anything else signifies an error.<br>&nbsp;6. Goto step 3 until all bytes sent<br><br><br>To Receive a file:<br>------------------<br><br>&nbsp;1. Wait for file header.<br>(2. Test CRC checksum of header when it arrives.)<br>(3. Check filename is that of file required if necessary.)<br>&nbsp;4. Send ASCII bytes "OK" if checksum/filename are OK, else any other two chars.<br>&nbsp;5. Receive 256 byte file packet<br>&nbsp;6. Receive 2 byte CRC of packet<br>&nbsp;7. Test CRC of packet<br>&nbsp;8. Goto step 4 until all bytes received.<br><br><br><br>Header Format - first 256 byte packet<br>-------------------------------------<br><br>$00 - $0F: ASCII filename<br>$10 - $11: Length of file (lo word)<br>$12 - $13: Length of file (hi word)&nbsp;&nbsp; &nbsp;<br>$14 - $1F: ASCII "Z80P.FHEADER" (12 chars)<br>$20 - $FF: All must be zero<br><br>(All words are in normal Z80 little-endian format)<br><br><br><br>File format:<br>------------<br>Bytes from the file, sent in 256 byte packets followed by a 2 byte checksum word.<br><br><br>CRC computation:<br>----------------<br><br>The calculation is described as a "standard CRC-CCITT that uses polynomial $1021"<br>and produces a 16 bit output, the Z80 code (slow, unoptimized) to generate it is<br>as follows:<br><br><br>;--Z80 code to make CRC --------------------------------------------------------<br><br>; makes checksum in HL, src addr = DE, length = C bytes<br><br>crc_checksum<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ld hl,$ffff&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br>crcloop&nbsp;&nbsp;&nbsp; &nbsp;ld a,(de)&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; xor h&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ld h,a&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ld b,8<br>crcbyte&nbsp;&nbsp;&nbsp; &nbsp;add hl,hl<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; jr nc,crcnext<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ld a,h<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; xor 10h<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ld h,a<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ld a,l<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; xor 21h<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ld l,a<br>crcnext&nbsp;&nbsp;&nbsp; &nbsp;djnz crcbyte<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; inc de<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; dec c<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; jr nz,crcloop<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ret<br><br>;----------------------------------------------------------------------------------</span></body></html>