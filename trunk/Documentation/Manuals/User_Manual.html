<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head><meta content="text/html; charset=ISO-8859-1" http-equiv="content-type"><title>User Manual</title></head>
<body><h2>V6Z80P Basic User Manual&nbsp;4-12-2012<br></h2><pre>(Online documentation &amp; link to main project archive: <a href="http://wiki.retroleum.co.uk">http://wiki.retroleum.co.uk)</a></pre><pre><br>=========================================================================================<br><br></pre><pre>As supplied, the V6Z80P system&nbsp;comprises&nbsp;three basic elements:</pre><pre>1. The PCB itself, this is the actual "V6Z80P".</pre><pre>2. An default architectural design for the FPGA called OSCA (Old School<br>   Computer Architecture) which is stored on an EEPROM. (There are currrently<br>   three additional FPGA architectures supplied on the EEPROM providing Spectrum 48,<br>   Spectrum 128 and Pentagon 128 cycle-pefect emulation. These were made by<br>   Alessandro Dorigatti.)</pre><pre>3. A simple command line operating system for OSCA called FLOS (Freezer-Like<br>   Operating System) also stored on the EERPOM but will load from SD card in<br>   preference if inserted.</pre><pre><br>The&nbsp;cables supplied for SCART TV connection, RS232 (serial) comms and Spectrum<br>EAR interface (where requested) are custom designed for the V6Z80P - the wiring<br>diagrams can be found elsewhere in the documentation folders.</pre><pre><br></pre><pre><span style="text-decoration: underline;">The V6Z80P PCB - A Brief Description:</span></pre><pre>The board is a 2-layer PCB, comprising mainly of a 20MHz CMOS Z80 CPU, Spartan2<br>XC2S150 FPGA and 3 SRAM chips (two 512KB and one 128KB) . There are two oscillators<br>present, 16MHz used for OSCA and 14MHz used for the Spectrum emulators. The video<br>DAC&nbsp;offers 12bit colour output via&nbsp;a standard VGA socket (the custom SCART cable<br>allows TV connection using RGB mode.) Stereo sound is output via a standard 3.5mm<br>Line Out jack socket. There are connectors for PC standard PS/2 keyboard and mouse,<br>Atari 2600-standard joysticks, RS232 serial and SD card IO. </pre><pre>The V6Z80P should be powered from a regulated 7.5 to 9.0 Volt DC mains adapter<br>with a 2.1mm jack (centre positive) capable of supplying about 800 mA (or more).</pre><pre>For full details, see the <a href="PCB_technical_manual.html">V6Z80P PCB manual</a><br><br><br></pre><pre><span style="text-decoration: underline;">An Outline of the&nbsp;OSCA Architecture:</span></pre><pre>OSCA's video system offers bitplane, byte map and tilemap style displays with data<br>sourced from a dedicated 512KB SRAM. Each mode allows hardware scrolling and a<br>256 colour palette. Other features include linedraw hardware, blitter data copier<br>and a scanline-synced co-processor for split screen effects. Up to 55 hardware sprites<br>per scanline can be displayed (each is 16 pixels wide, up to 240 lines high with<br>256 colours). A 128KB RAM chip is dedicated to sprite definitions.</pre><pre>There are four&nbsp;audio&nbsp;channels each capable of playing 8-bit signed sample data<br>via DMA (in a similar fashion to the Amiga).</pre><pre>OSCA also contains interface hardware for a PS/2 keyboard and mouse, SD card and<br>joysticks as well as memory paging registers etc accessed through Z80 ports.</pre><pre>For full details of OSCA, see the <a href="OSCA_Hardware_Manual.html">OSCA Hardware Manual</a><br><br><br></pre><pre><span style="text-decoration: underline;">Brief description of the "FLOS" Operating System</span></pre><pre>FLOS is a simple command line operating system / memory monitor similar to those<br>used by freezer cartridges for the 1980s home computers. In some ways it behaves<br>like a more modern DOS in that disk-based programs can be executed simply by entering<br>their filenames. The usual commands are present (show memory as hex, disassemble,<br>load and save bytes to RAM etc).</pre><pre>FLOS uses the FAT16 file system and loads from a file on the root of the SD card<br>(or from the onboard EEPROM). Naturally, it can be replaced with any arbitrary code<br>that is required to load at boot up.<br><br>For detailed info see the <a href="FLOS_Manual.html">FLOS user manual</a>.</pre><pre><br></pre><pre><br><span style="text-decoration: underline; font-weight: bold;">Powering Up:</span></pre><pre>Download the full project archive (to PC) then format an SD card to FAT16 (please<br>use a good brand to ensure compatibility). Copy the contents of the folder "V6_SD_Card"<br>from the project archive to the card and insert into the V6Z80P's card slot. </pre><pre>Connect&nbsp;the power jack to the DC socket, a PS/2 keyboard and video/audio cables. If using a<br>VGA monitor, make sure the VGA-mode jumper (on the right side of 10 pin header) is installed.</pre><pre><br><img style="width: 239px; height: 89px;" alt="VGA mode jumper" src="images/vga_mode_jp.png"></pre><pre><br>The JTAG mode jumpers (J1 and J2) should be uninstalled for normal&nbsp;start-up. You can<br>now flick the power switch near the DC jack across to the right and the V6Z80P should<br>power up. The status LED lights up, a black and white bootloader screen appears, after<br>which FLOS loads. Once loaded, you can type "?" &lt;return&gt; for a list of internal commands<br>(for details use the command "HELP (command_name)" or see the <a href="FLOS_Manual.html">FLOS user manual</a>.</pre><pre>Z80 programs with .exe filename extensions can be run from the SD card (use the<br>command line to navigate in a similar manner to DOS).&nbsp; Most of the demos etc can<br>be quit by pressing the ESC key (note: some programs were coded specifically<br>for the PAL TV system so may not work properly on VGA or in 60Hz NTSC display modes).</pre><pre>The system can also run without an SD card as FLOS is installed by default on<br>the EEPROM. However, this limits its use since everything but the internal commands<br>must be loaded into memory via Serial Link.</pre><pre>To send and receive data to FLOS, use the "Serial_link"&nbsp;utility provided on the PC<br>(see the "PC_based_apps" folder in project archive) and use the custom DSUB9 to<br>4 pin mini-DIN serial cable provided. The FLOS commands RX (receive to memory),<br>TX (transmit from memory) and FRX (receive file and save to SD card) are used for<br>FLOS command line file transfer. For details see the <a href="Serial_Link_Info.html">Serial Comms Manual</a>.</pre><pre><br></pre><pre style="font-weight: bold;"><span style="text-decoration: underline;">FPGA Configs:</span></pre><pre>The onboard EEPROM can store multiple FPGA configurations in what (for simplicity)<br>are called "slots". On power-up, the FPGA starts from whichever is set to the<br>"Power-on Boot Slot". As supplied, OSCA for 50Hz PAL TVs in Slot 1 and OSCA for<br>60Hz NTSC TVs is in Slot 2 (the default boot slot will depend on the locale the<br>board was dispatced to.)</pre><pre>V6Z80P+ v1.1 boards come with Alessandro Dorigatti's Spectrum emulators<br>(Slot 3: Spectrum 48 Slot 4: Spectrum 128, Slot 5: Pentagon 128). These configs<br>must be launched with the FLOS command EMU (as they need to preload data such<br>as the Spectrum ROM). Each of the emulators supports ResiDOS or esxDOS Operating<br>Systems - this is selected with a jumper in the V6Z80P header group. When<br>the jumper is on, the emulators use esxDOS mode, and when it is off, Residos is<br>used. Note the NMI jumper is not used for the Spectrum emulators, the NMI feature<br>(EG: go to file browser in esxDOS) is mapped to the SCROLL_LOCK key. Please see the<br>folder Alternative_Configs/Alessandro/ for full details on the Spectrum emulators.</pre><pre><br><img style="width: 239px; height: 89px;" alt="Spectrum mode" src="images/spectrum_mode.png"></pre><pre>All the configs supplied support VGA output&nbsp;using the rightmost jumper as<br>shown earlier.</pre><pre><br></pre><pre><span style="text-decoration: underline;">How to install new FPGA configs:</span></pre><pre>In FLOS, enter the command "EEPROM"&nbsp; (no quotes)</pre><pre>1. Choose Option 1 "Write config to slot".<br>2. When asked which slot, choose a slot showing "UNKNOWN" or a slot other than<br>&nbsp; &nbsp;the power-on boot slot.<br>3. Browse to the config's .bin or .v6c file (or choose "RS232" in the requester to use<br>&nbsp;&nbsp; the serial download option)<br>4. Wait for file to load, write to the EEPROM and complete verification.</pre><pre>If the config is a bootable, standalone atchitecture (EG: a new version of OSCA) you<br>should now test it by choosing Option 2 - "Reconfigure from a slot now (Non-permanent)<br>and enter the slot number you used in step 2.</pre><pre>The FPGA will restart using the new config - this selection persists until&nbsp;cold reset.<br>If everything is OK, you can reload the EEPROM tool and choose option 3 to make the new<br>config the Power-On Boot Slot.</pre><pre>If the system does not start <span style="text-decoration: underline;">from power up</span> and the power LED flashes at a rate of about<br>1 pulse per second, the FPGA is not receiving a valid config file. To remedy this,<br>see: <a href="#Manual_Power-on_Boot_Slot_Setting:">Manual Boot Slot Setting</a></pre><pre><br></pre><pre><br><span style="text-decoration: underline; font-weight: bold;">Other Jumper Pins:</span></pre><pre>Four other pins in the header group are used by OSCA / FLOS for Warm Reset and NMI (program<br>freezer). Button switches should be connected to these pin headers if these functions<br>are required. Note that the reset input here only resets the CPU and some of OSCA's<br>registers, it does not reconfigure the FPGA (see the info regarding jumper J2 for a<br>method to do that).</pre><pre><img style="width: 239px; height: 89px;" alt="other pins" src="images/other_jumpers.png"></pre><pre><br></pre><pre style="text-decoration: underline;">Jumpers J1 and J2:</pre><pre>These jumpers are mainly needed when configuring the FPGA from a JTAG cable<br>(EG: when testing new configurations). To enter JTAG config mode, with the power off, <br>install both jumpers and power on - the status LED flashes rapidly signifying that a<br>JTAG config should be sent to the board. </pre><pre>J2 also has additional functions: If a button is placed across J2 (and firmware 6.37<br>or above is installed in the config PIC) it can be used as a Cold Reset. IE: When the<br>button is pressed, the FPGA will reconfigure from whichever is the power-on boot slot<br>(this in turn causes a CPU reset). This is useful for escaping from the Spectrum emulators<br>without powering off/on.</pre><pre>J2 can also be used to manually set the power-on boot config slot (which is useful if an<br>incorrect slot has been set via software). See <a href="#Manual_Power-on_Boot_Slot_Setting:">Manual Boot Slot Setting</a>.<br><br></pre><pre><br><span style="text-decoration: underline; font-weight: bold;">The Boot Procedure:</span><br><br>When the power is switched on, a PIC microcontroller first checks for JTAG config mode<br>(J2 installed). If J2 is not shorted, the microcontroller&nbsp;clocks config data from the<br>selected power-on boot slot in the EEPROM into the FPGA. The FPGA configures and resets<br>the Z80, which then runs a small 512 byte ROM held within the FPGA. This ROM code loads<br>a bootloader from the EEPROM, which runs and&nbsp;loads the OS. (The OS can load from SD card,<br>EEPROM or via Serial Link - in that order of priority).</pre><pre>If the&nbsp;ROM cannot load a valid bootcode file from the EEPROM, the display will flash<br>magenta (bad CRC) or green (time out). If OSCA version 661 or above is installed it<br>is possible to send the bootcode file manually via the serial link when the display<br>turns grey. It is also possible to force serial transfer of the bootcode on power up<br>by holding UP+RIGHT+FIRE on a joystick in port A. (Note: The baud rate must be 115200).</pre><pre><br>On the bootloader screen, the following keys are active:</pre><pre>ESC - Cancel the boot process and wait for an OS to be downloaded via serial link<br> &nbsp; &nbsp; &nbsp;Whilst waiting, you can press F11 and F12 set the BAUD rate (default is 115200)<br> &nbsp; &nbsp;&nbsp;&nbsp;or press Left CTRL to reboot.<br><br>F1-F7 - Reconfigure the FPGA from an EEPROM slot (note: you cannot start<br>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;Alessandro's Spectrum emulators in this way - you must use the FLOS<br> &nbsp; &nbsp; &nbsp; &nbsp;command&nbsp;EMU for to start these).</pre><pre><br><br><span style="text-decoration: underline;"></span><span style="text-decoration: underline; font-weight: bold;">Tips / Troubleshooting:</span></pre><pre><span style="text-decoration: underline;"><br>General:</span><br><br>Avoid connecting or disconnecting anything to the V6Z80P whilst the power is switched on<br>(SD cards shouldn't be a problem, however FLOS cannot automatically recognize card swaps<br>and any card inserted whilst the power is on&nbsp;needs to be initialized with the "MOUNT"<br>command).</pre><pre><span style="text-decoration: underline;"><br>FLOS:</span> </pre><pre>If you have any problems formatting an SD card to FAT16 on the PC, try doing it under<br>FLOS with the command: FORMAT SD_CARD</pre><pre>You can create a multi-volume SD card if you wish by using the FLOS utility DISKTOOL.<br>This can make up to 4 partitions using the 4 slots in the Master Boot Record. Note however,<br>that Windows (XP) will only see the first partition since it uses a different scheme for<br>partitioning. (Linux will gnerally see all the FLOS partitions).</pre><pre><br><span style="text-decoration: underline;">Serial Comms:</span></pre><pre>Whilst the Windows GUI "Serial Link" is useful for occasional file transfers, it may be<br>more convenient to use "SerialTX". This is a console / command line based utility<br>(found in the project's "PC-based Apps" folder) which can send files&nbsp;from other<br>programs etc, via "open with" etc. It can also be handy to copy FileTX to Windows'<br>"Send To" list so that files can be send via a right click -&gt;Send To.</pre><pre style="text-decoration: underline;"><br>Peripherals:</pre><pre>Serial port: If your PC does not have a 9 pin serial connector, a USB serial adapter<br>should work fine. &nbsp;The "Prolific" chipset cables (about £2-£10 on eBay) are known to<br>work well, but make sure you get the latest drivers.</pre><pre>USB keyboards: A modern USB keyboard can be used if it came with a PS/2 adapter but<br>some of these keyboards have unusual / slow start up sequences. If you encounter<br>problems, create a text file in the root of your SD card called SYSTEM.CFG containing<br>the line RESETKB=0. (The default bootloader action is to reset the keyboard and wait<br>for acknowledgement).</pre><pre>Joystick ports: Essentially these are wired as per the standard Atari 2600 style. The<br>second fire button is connected to pin 9 (same as on the Amiga). Pin 5 is connected<br>to 3.3volts (via a small resistor (22ohm) so can provide a little power - this should<br>allow Megadrive pads to be used too). Pin 7 is unconnected.</pre><pre>SD cards: It has been found that some ultra cheap cards do not work in the V6Z80P (and<br>other hobbyist project boards). Good brand MMC, SD and SDHC cards should all work. </pre><pre><br></pre><pre><br><span style="text-decoration: underline; font-weight: bold;"><a name="Manual_Power-on_Boot_Slot_Setting:"></a>Manual Power-on Boot Slot Setting:</span></pre><pre><br>If the FPGA does not receive a valid configuration pattern from the EEPROM upon<br>power on, the status LED will flash slowly (around 1 flash per second). There are<br>various ways to fix this..</pre><pre style="text-decoration: underline;">Recovery procedure for V6Z80P+ Boards</pre><pre>OPTION 1: Assuming there is a working config in Slot 1 - 7 and the problem is just that<br>          the Power-On Boot Slot selection is pointing at a bad config:</pre><pre>* Power off.<br>* Install jumper J2 only (or hold down button if one is connected to J2)<br>* Power on (status led flashes rapidly).<br>* Remove jumper J2 again (or release button)<br>* If the LED continues to flash rapidly, install and remove jumper (press and release button)<br>* The status LED will now flash once, pause about 5 seconds, then flash twice, pause 5 seconds,<br>&nbsp; then flash three times and so on - the number of flashes represents the power-on slot selection.<br>&nbsp; During the pause following the slot selection you require, replace the jumper (or press the button)<br>&nbsp; the LED will then stay on permanently signifying that the slot has been set.<br>* Power off and remove Jumper J2 (or release the button)</pre><pre><br>OPTION 2: JTAG configuration - requires suitable Xilinx JTAG cable.<br><br>* Power off and connect JTAG cable to the V6Z80P.<br>* Install jumpers J1 and J2.<br>* Load the most recent OSCA project into Xilinx webpack ISE 10.1 and send the OSCA<br>&nbsp; config .bit file from the PC to the V6Z80P via the Impact option.<br>* If the bootcode is intact in the EEPROM, the system will start as normal allowing you to<br>&nbsp; load EEPROM.EXE via FLOS. If the bootcode checksum fails the screen will flash magenta,<br>&nbsp; then grey, you will need to send the bootcode (.epr file from the bootcode folder) via<br>  serial link and then run EEPROM to install it.<br>* Remove jumpers J1 and J2 next time you power off so that the system automatically<br>&nbsp; configures from the EEPROM.</pre><pre><br><span style="text-decoration: underline;">Recovery procedure for the original V6Z80P Board</span></pre><pre>OPTION 1: With Config PIC firmware v616+ the Active Slot can be changed manually.&nbsp;Assuming<br>          there is a working config in Slot 1, 2 or 3 and the problem is just that the power<br>          on boot slot selection is pointing at a bad config:</pre><pre>* Power off.<br>* Install jumper J2 only<br>* Power on (yellow led flashes rapidly - JTAG mode).<br>* Remove jumper J2 again<br>* The PIC will reset the active slot to 1 (indicated by 1 pulse of the red LED)<br>&nbsp; The yellow led lights up for 4 seconds then Slot 2 is set (2 flashes of red LED),<br>&nbsp; again there's a 4 second pause, finally slot 3 is set (3 flashes).<br>* Power off only when the yellow LED is lit following the desired slot setting.<br>* When you power on the active slot will correctly point to slot 1, 2 or 3.</pre><pre><br>OPTION 2:  Remove and reprogram the EEPROM or config PIC externally. <br><br>It is the PIC chip that actually holds the slot selection - you will only need to reprogram<br>the PIC if you have old firmware that doesn't support the manual slot selection. If you do<br>reprogram the PIC, use the latest firmware .hex file so that you wont have to do so again.<br>If you reprogram the EEPROM, use "default.bin" from the folder development_files/v6z80p/eeprom<br>this also contains the bootcode for SLOT 0.</pre><pre><br>OPTION 3: JTAG config. If none of the first 3 slots contain OSCA:</pre><pre>* Power off and connect a Xilinx JTAG cable to the V6Z80P.<br>* Install jumpers J1 and J2.<br>* Load the most recent OSCA project into Xilinx webpack ISE and send the OSCA config .bit<br>&nbsp; file from the PC to the V6Z80P via JTAG.<br>* If the bootcode is intact in the EEPROM, the system will start as normal allowing you to load<br>&nbsp; EEPROM.EXE via FLOS. If the bootcode checksum fails the screen will flash magenta, then grey.<br>&nbsp; You will need to send the bootcode (.epr file from the bootcode folder) via serial link and<br>  then run EEPROM to install it.<br>* Remove jumpers J1 and J2 next time you power off so that the system automatically configures<br>&nbsp; from the EEPROM.<br></pre><pre>==================================================================================================<br><span style="text-decoration: underline;"><br>Further&nbsp;Reading:</span><br><br><a href="FLOS_Manual.html">FLOS manual</a> - In depth FLOS user manual<br><br><a href="OSCA_Hardware_Manual.html">OSCA manual</a> - Full OSCA hardware description / register list<br><br><a href="PCB_technical_manual.html">PCB tech manual</a> - Detail about the physical PCB.<br><br><a href="Serial_Link_Info.html">Serial Comms manual</a> - More info concerning RS232 comms<br><br><a href="ROM_and_Bootcode_Info.html">ROM and Bootcode manual</a> - In depth info about the start up procedure.<br><br>==================================================================================================<br><span style="text-decoration: underline;"><br></span><br><br><br><br></pre></body></html>