# Main makefile
# This file must be "included" in user project makefile

SHELL=cmd.exe
# (assembler name was as-z80.exe for old SDCC 2.9.0)
AS=sdasz80

basedir = $(v6z80pdir)/Contributions/Valen/c_programs


# object file extension ("rel" for SDCC 2.9.7 and "o" for old SDCC 2.9.0)
O=rel
RM=del

objects = $(basedir)/c_support/crt/obj/crt0_v6z80p.$(O)                   \
          $(basedir)/c_support/os_interface_for_c/obj/i_flos.$(O)         \
          $(basedir)/c_support/os_interface_for_c/obj/i_flos_lib.lib      \
          $(basedir)/c_support/stdio_v6z80p/obj/stdio_v6z80p_lib.lib          \
          $(basedir)/c_support/os_proxy/obj/flos_proxy_code.$(O)          \
          $(basedir)/src/$(prjname)/obj/myheap.$(O)


INC=-I$(basedir)/inc

# Output redirection to stdout (instead of stderr), for Windows shell.
# Also QtCreator IDE want redirection to stderr.
# use_stdout = "--use-stdout"

     
v6-exe/$(prjname).exe : $(objects) $(prjobjects) $(prjbinaries)
	@echo ----------------- Linking -------------------
	$(RM) obj\*.ihx
	$(RM) obj\*.bin
	$(RM) obj\*.exe
	sdcc  -o obj/ -mz80   $(use_stdout)  --no-std-crt0   $(linkopt)  -Wl-b_FLOS_PROXY_CODE=0x5080  $(objects) $(prjobjects)
	ren obj\crt0_v6z80p.ihx $(prjname).ihx
	@echo ------------- IHX to BIN convertion ---------
	..\..\c_support\tools\srec_cat obj\$(prjname).ihx -intel -offset -0x5000   -o obj\$(prjname).exe -binary  
# -- copy to EXE dir
#	ren obj\00005000.bin $(prjname).exe
	copy obj\$(prjname).exe v6-exe\ > nul
# this line is for copy exe to my z: disk, you can remove this line
	copy v6-exe\*.exe z:\\




# -------------------------------------------------


# OS interface for C  (object file)
myd1   = $(basedir)/c_support/os_interface_for_c
myd1_  = $(subst /,\,$(myd1))
$(myd1)/obj/i_flos.$(O) : $(myd1)/i_flos.c 
	cd $(myd1_) && sdcc -c -o obj/ $(INC) --std-sdcc99  -mz80   --opt-code-speed $(use_stdout)     i_flos.c



# Library content. OS interface for C.
# .rel <-- .c
myd7   = $(basedir)/c_support/os_interface_for_c
myd7_  = $(subst /,\,$(myd7))
# Include Library makefile
include $(myd7)/Makefile_lib


# stdio_v6z80p
#$(basedir)/c_support/stdio_v6z80p/obj/stdio_v6z80p.$(O) : $(basedir)/c_support/stdio_v6z80p/stdio_v6z80p.c      \
#                                                          $(basedir)/c_support/stdio_v6z80p/sysapi.c
#	cd $(basedir)/c_support/stdio_v6z80p/ &&  sdcc -c -o obj/ $(INC) --std-sdcc99  -mz80   --opt-code-speed $(use_stdout)  --no-std-crt0   stdio_v6z80p.c
myd8   = $(basedir)/c_support/stdio_v6z80p
myd8_  = $(subst /,\,$(myd8))
# Include Library makefile
include $(myd8)/Makefile_lib


# Asm proxy (object file)
myd2  = $(basedir)/c_support/os_proxy
myd2_ = $(subst /,\,$(myd2))
$(myd2)/obj/flos_proxy_code.$(O) : $(myd2)/flos_proxy_code.c 
	cd $(myd2_) && sdcc -c -o obj/ --std-sdcc99  -mz80   --opt-code-speed $(use_stdout)  --no-std-crt0   --constseg FLOS_PROXY_CODE flos_proxy_code.c


# Asm proxy 
# C source file <-- binary file <-- pasmo .asm files
myd3  = $(basedir)/c_support/os_proxy
myd3_ = $(subst /,\,$(myd3))
$(myd3)/flos_proxy_code.c : $(myd3)/flos.asm $(myd3)/i__kernal_jump_table.asm $(myd3)/macro.asm
	cd $(myd3_) && %v6z80pdir%\pasmo\pasmo.exe -d -I %v6z80pdir%\equates  flos.asm flos.asm.bin > obj\flos.asm.output
# Generate C source from binary file	
	cd $(myd3_) && echo /* Machine generated. Dont edit. */ const > flos_proxy_code.c
	cd $(myd3_) && "../tools/xd.exe" -dflos_proxy_code flos.asm.bin >> flos_proxy_code.c


# C runtime (object file) 
# .o file <-- .s file
myd4  = $(basedir)/c_support/crt
myd4_ = $(subst /,\,$(myd4))
$(myd4)/obj/crt0_v6z80p.$(O) : $(myd4)/crt0_v6z80p.s
	cd $(myd4_) && $(AS) -o obj/crt0_v6z80p.$(O) crt0_v6z80p.s



# heap (obj file) 
# .o file <-- heapsize file
myd5  = $(basedir)/src/$(prjname)
myd5_ = $(subst /,\,$(myd5))
$(myd5)/obj/myheap.$(O) : $(myd5)/heapsize
	@echo ----------------- Heap allocation -------------------
	cd $(myd5_) && cd obj && type ..\..\..\c_support\myheap.s > myheap.s
	cd $(myd5_) && type heapsize             >> obj/myheap.s
	cd $(myd5_) && cd obj && $(AS) -o myheap.$(O) myheap.s


# Default heapsize file (if no heapsize file exist, provide default file with heap size 0)
# Generate heapsize file
myd6  = $(basedir)/src/$(prjname)
myd6_ = $(subst /,\,$(myd6))
$(myd6)/heapsize : 
	cd $(myd6_) && echo 0 > heapsize

